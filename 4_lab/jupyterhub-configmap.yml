apiVersion: v1
kind: ConfigMap
metadata:
  name: jupyterhub-config
  labels:
    app: jupyterhub
    version: v1
    component: application
data:
  JUPYTERHUB_LOG_LEVEL: "INFO"
  JUPYTERHUB_CRYPT_KEY: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
  PYTHONUNBUFFERED: "1"
  jupyterhub_config.py: |
    import os
    
    # Configure the authenticator
    c.JupyterHub.authenticator_class = 'jupyterhub.auth.DummyAuthenticator'
    c.DummyAuthenticator.password = os.environ.get('JUPYTERHUB_PASSWORD', 'any-password')
    c.Authenticator.allow_all = True

    # Configure the spawner
    c.JupyterHub.spawner_class = 'simple'
    c.Spawner.default_url = '/lab'
    c.Spawner.cmd = ['jupyterhub-singleuser']

    # Configure the database using environment variables
    db_url = (
        "postgresql://"
        f"{os.environ['POSTGRES_USER']}:"
        f"{os.environ['POSTGRES_PASSWORD']}@"
        f"{os.environ['POSTGRES_HOST']}:"
        f"{os.environ['POSTGRES_PORT']}/"
        f"{os.environ['POSTGRES_DB']}"
    )
    c.JupyterHub.db_url = db_url

    # Configure the hub
    c.JupyterHub.hub_ip = '0.0.0.0'
    c.JupyterHub.hub_port = 8081
    c.JupyterHub.bind_url = 'http://0.0.0.0:8000'  # Только bind_url, без ip/port

    # Configure logging
    c.Application.log_level = os.environ.get('JUPYTERHUB_LOG_LEVEL', 'INFO')

    # Security settings
    c.JupyterHub.cookie_secret_file = '/tmp/jupyterhub_cookie_secret'
    c.JupyterHub.trust_user_provided_tokens = False
    
    # CORS settings for WebSocket
    c.JupyterHub.allow_origin = '*'
    c.JupyterHub.allow_remote_origin = ['*']
    c.JupyterHub.allow_credentials = True
    
    # Allow all origins for notebook server
    c.ServerApp.allow_origin = '*'
    c.ServerApp.allow_remote_origin = ['*']
    c.ServerApp.allow_credentials = True
    
    # WebSocket specific settings
    c.ServerApp.websocket_allowed_origins = "*"
    c.ServerApp.disable_check_xsrf = True
    c.ServerApp.allow_origin = '*'
    c.ServerApp.allow_remote_origin = ['*']
    c.ServerApp.allow_credentials = True
    c.ServerApp.trust_xheaders = True
    
    # Configure tornado settings for CORS
    import tornado.web
    c.JupyterHub.tornado_settings = {
        "headers": {
            "Content-Security-Policy": "frame-ancestors 'self' *",
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Methods": "*",
        },
        "cookie_options": {
            "SameSite": "Lax",  # Changed from None to Lax for better compatibility
            "Secure": False,  # Отключаем Secure для локальной разработки
        },
    }
    
    # Configure notebook server tornado settings for CORS
    c.ServerApp.tornado_settings = {
        "headers": {
            "Content-Security-Policy": "frame-ancestors 'self' *",
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Allow-Methods": "*",
        },
    }
    
    # Disable XSRF for local development
    c.Application.disable_check_xsrf = True
    tornado.web.RequestHandler._check_xsrf_cookie = lambda self: None
    
    # Additional trusted origins and headers
    c.JupyterHub.trusted_origins = ["http://127.0.0.1:*", "http://localhost:*"]
    c.JupyterHub.trusted_headers = [
        "x-forwarded-for",
        "x-forwarded-proto", 
        "x-forwarded-host",
        "x-forwarded-port",
    ]

    # Configure proxy
    c.JupyterHub.cleanup_servers = False
    c.JupyterHub.cleanup_proxy = False

    # Performance settings
    c.JupyterHub.concurrent_spawn_limit = 10
    c.JupyterHub.active_server_limit = 20
